{% extends "base.html" %}
{% block title %}Agenda Global{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 pb-12">
    <!-- Header / Controls (Hidden on Print) -->
    <header class="bg-card border-b border-white/10 print:hidden">
        <div class="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <a href="{{ url_for('report.index') }}" class="text-white/60 hover:text-white">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
                <h1
                    class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-pink-600 bg-clip-text text-transparent">
                    <i class="fas fa-calendar-alt mr-2"></i>Agenda Global
                </h1>
            </div>

            <!-- Navigation Tabs (Screen only) -->
            <div
                class="w-full md:w-auto overflow-x-auto overflow-y-hidden hide-scrollbar max-w-[100vw] pb-1 print:hidden">
                <div class="flex bg-white/5 rounded-lg p-1 gap-1 min-w-max">
                    <a href="{{ url_for('report.global_schedule') }}"
                        class="px-4 py-2 rounded-md text-sm font-bold bg-purple-600 text-white shadow flex-shrink-0">Agenda</a>
                    <a href="{{ url_for('report.global_schedule_config') }}"
                        class="px-4 py-2 rounded-md text-sm text-white/60 hover:text-white hover:bg-white/5 transition-colors flex-shrink-0">Precios</a>
                    <a href="{{ url_for('report.global_schedule_history') }}"
                        class="px-4 py-2 rounded-md text-sm text-white/60 hover:text-white hover:bg-white/5 transition-colors flex-shrink-0">Historial</a>
                    <a href="{{ url_for('report.global_schedule_summary') }}"
                        class="px-4 py-2 rounded-md text-sm text-white/60 hover:text-white hover:bg-white/5 transition-colors flex-shrink-0">Resumen</a>
                    <a href="{{ url_for('report.global_schedule_financials') }}"
                        class="px-4 py-2 rounded-md text-sm text-white/60 hover:text-white hover:bg-white/5 transition-colors flex-shrink-0">Finanzas</a>
                </div>
            </div>

            <form action="{{ url_for('report.global_schedule') }}" method="GET"
                class="flex flex-wrap items-center justify-center gap-2 md:gap-4 w-full md:w-auto mt-2 md:mt-0">
                <input type="date" name="date" value="{{ selected_date.strftime('%Y-%m-%d') }}"
                    onchange="this.form.submit()"
                    class="w-full sm:w-auto bg-white/10 border border-white/20 rounded px-4 py-2 text-white focus:outline-none focus:border-purple-500">

                <div class="flex gap-2 md:gap-4 w-full sm:w-auto">
                    <button type="button" onclick="triggerMobilePrint()"
                        class="flex-1 sm:flex-none justify-center bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded border border-white/20 transition-colors flex items-center">
                        <i class="fas fa-print mr-2"></i>Imprimir
                    </button>

                    <a href="{{ url_for('report.export_global_schedule', date=selected_date.strftime('%Y-%m-%d')) }}"
                        class="flex-1 sm:flex-none justify-center bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded border border-white/20 transition-colors flex items-center">
                        <i class="fas fa-file-excel mr-2"></i>Excel
                    </a>
                </div>
            </form>
        </div>
    </header>

    <!-- Schedule Content -->
    <main class="max-w-7xl mx-auto px-0 md:px-6 py-8">

        <!-- Print Header (Visible only on Print) -->
        <div class="hidden print:block text-center mb-8 border-b-2 border-black pb-4">
            <h1 class="text-3xl font-black text-black">AGENDA DE PARTIDOS</h1>
            <p class="text-lg font-bold text-gray-600 block">{{ selected_date.strftime('%d/%m/%Y') }}</p>
        </div>

        {% if not schedule %}
        <div class="text-center py-20 print:hidden">
            <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-calendar-times text-2xl text-white/40"></i>
            </div>
            <h3 class="text-xl font-bold text-white/60">No hay partidos programados</h3>
            <p class="text-white/40">Selecciona otra fecha para ver la agenda.</p>
        </div>
        {% endif %}

        <div class="space-y-8 print:space-y-8">
            {% for court_name, data in schedule.items() %}
            <div class="break-inside-avoid">
                <!-- Court Header -->
                <div
                    class="bg-gradient-to-r from-green-600 to-green-700 text-white py-2 px-4 text-center font-bold text-xl uppercase tracking-wider print:bg-none print:bg-gray-200 print:text-black print:border-y-2 print:border-black">
                    CANCHA: {{ court_name }}
                </div>

                <!-- Matches Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead>
                            <tr
                                class="bg-white/5 text-white/60 print:text-black print:bg-white print:border-b print:border-black">
                                <th class="py-2 px-4 w-24 text-center font-bold whitespace-nowrap">HORA</th>
                                <th class="py-2 px-4 font-bold">CATEGOR√çA</th>
                                <th class="py-2 px-4 font-bold text-right" style="width: 20%;">LOCAL</th>
                                <th class="py-2 px-4 w-20 text-center text-white/20 print:text-black/20">$ LOCAL</th>
                                <th class="py-2 px-4 w-24 text-center text-white/20 print:text-black/20">vs</th>
                                <th class="py-2 px-4 w-20 text-center text-white/20 print:text-black/20">$ VISITA</th>
                                <th class="py-2 px-4 font-bold text-left" style="width: 20%;">VISITANTE</th>
                                <th class="py-2 px-4 w-24 text-center font-bold text-white/80 print:text-black">$
                                    ARBITRO</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5 print:divide-gray-300">
                            {% for match in data.matches %}
                            <tr class="hover:bg-white/5 print:hover:bg-transparent">
                                <td
                                    class="py-2 px-4 text-center font-mono font-bold text-white/80 print:text-black whitespace-nowrap">
                                    {{ match.match_date.strftime('%I:%M %p') }}
                                </td>
                                <td class="py-2 px-4 text-white/60 print:text-black uppercase text-xs tracking-wide">
                                    {{ match.league.name }}
                                </td>
                                <td class="py-2 px-4 text-right font-bold text-white print:text-black leading-tight">
                                    {{ match.home_team.name }}
                                </td>
                                <td class="py-2 px-1 text-center">
                                    <input type="text"
                                        class="w-full bg-transparent text-center font-mono text-sm border-b border-transparent hover:border-white/20 focus:border-purple-500 focus:outline-none text-red-400 print:text-black print:border-none uppercase"
                                        value="{{ match.referee_cost_home if match.referee_cost_home != '0' else '' }}"
                                        placeholder="-" data-field="referee_cost_home"
                                        onchange="updateMatchCost('{{ match.id }}', 'referee_cost_home', this.value, '{{ court_name|replace(' ', '_') }}')">
                                </td>
                                <td class="py-2 px-1 text-center whitespace-nowrap">
                                    <div class="flex items-center justify-center gap-1">
                                        <input type="text"
                                            class="w-10 bg-transparent text-center font-bold text-lg border-b border-transparent hover:border-white/20 focus:border-purple-500 focus:outline-none text-white print:text-black"
                                            value="{{ match.home_score if match.home_score is not none else '' }}"
                                            placeholder="-" inputmode="numeric"
                                            onchange="updateMatchScore('{{ match.id }}', 'home_score', this.value)">
                                        <span class="text-white/20 print:text-black/20 text-xs">-</span>
                                        <input type="text"
                                            class="w-10 bg-transparent text-center font-bold text-lg border-b border-transparent hover:border-white/20 focus:border-purple-500 focus:outline-none text-white print:text-black"
                                            value="{{ match.away_score if match.away_score is not none else '' }}"
                                            placeholder="-" inputmode="numeric"
                                            onchange="updateMatchScore('{{ match.id }}', 'away_score', this.value)">
                                    </div>
                                </td>
                                <td class="py-2 px-1 text-center">
                                    <input type="text"
                                        class="w-full bg-transparent text-center font-mono text-sm border-b border-transparent hover:border-white/20 focus:border-purple-500 focus:outline-none text-red-400 print:text-black print:border-none uppercase"
                                        value="{{ match.referee_cost_away if match.referee_cost_away != '0' else '' }}"
                                        placeholder="-" data-field="referee_cost_away"
                                        onchange="updateMatchCost('{{ match.id }}', 'referee_cost_away', this.value, '{{ court_name|replace(' ', '_') }}')">
                                </td>
                                <td class="py-2 px-4 text-left font-bold text-white print:text-black leading-tight">
                                    {{ match.away_team.name }}
                                </td>
                                <td class="py-2 px-1 text-center">
                                    <input type="text"
                                        class="w-full bg-transparent text-center font-mono text-sm border-b border-transparent hover:border-white/20 focus:border-purple-500 focus:outline-none text-yellow-400 print:text-black print:border-none uppercase"
                                        value="{{ match.referee_cost if match.referee_cost != '0' else '' }}"
                                        placeholder="-" data-field="referee_cost"
                                        onchange="updateMatchCost('{{ match.id }}', 'referee_cost', this.value, '{{ court_name|replace(' ', '_') }}')">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot id="footer-{{ court_name|replace(' ', '_') }}">
                            <!-- Totals Row -->
                            <tr
                                class="bg-white/10 font-bold print:bg-gray-100 print:text-black border-t-2 border-white/20 print:border-black">
                                <td colspan="3" class="py-2 px-4 text-right uppercase text-xs tracking-wider">Totales:
                                </td>
                                <td class="py-2 px-1 text-center font-mono text-green-400 print:text-black text-sm"
                                    data-type="total-home">
                                    ${{ data.total_cost_home }}
                                </td>
                                <td></td>
                                <td class="py-2 px-1 text-center font-mono text-green-400 print:text-black text-sm"
                                    data-type="total-away">
                                    ${{ data.total_cost_away }}
                                </td>
                                <td></td>
                                <td class="py-2 px-1 text-center font-mono text-yellow-400 print:text-black text-sm"
                                    data-type="total-referee">
                                    ${{ data.total_referee }}
                                </td>
                            </tr>
                            <!-- Profit Row -->
                            <tr
                                class="bg-black/20 print:bg-gray-200 print:text-black border-t border-white/10 print:border-black">
                                <td colspan="7" class="py-2 px-4 text-right uppercase text-xs tracking-wider">Ganancia
                                    (Ingresos - Gastos):</td>
                                <td class="py-2 px-1 text-center font-mono text-lg font-bold {{ 'text-green-400' if data.total_profit >= 0 else 'text-red-400' }} print:text-black"
                                    data-type="total-profit">
                                    ${{ data.total_profit }}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
    </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    function triggerMobilePrint() {
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            const btn = document.querySelector('button[onclick="triggerMobilePrint()"]');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>PDF...';
            btn.disabled = true;

            const element = document.querySelector('main');
            // Remove padding to maximize space
            element.classList.remove('max-w-7xl', 'md:px-6');
            element.style.padding = '0';
            element.style.background = '#111827';

            // Hide elements we don't want in the PDF
            const noPrintElements = element.querySelectorAll('.print\\:hidden');
            noPrintElements.forEach(el => el.style.display = 'none');

            const opt = {
                margin: 0.2,
                filename: 'agenda_{{ selected_date.strftime("%Y-%m-%d") }}.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                btn.innerHTML = oldHtml;
                btn.disabled = false;
                // Restore
                element.classList.add('max-w-7xl', 'md:px-6');
                element.style.padding = '';
                element.style.background = '';
                noPrintElements.forEach(el => el.style.display = '');
            }).catch(err => {
                console.error(err);
                btn.innerHTML = oldHtml;
                btn.disabled = false;
                alert("Error al generar PDF");
            });
        } else {
            window.print();
        }
    }
</script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/report_global_schedule.css') }}">

<script>
    window.updateMatchCostsUrl = "{{ url_for('report.update_match_costs') }}";
    window.csrfToken = "{{ csrf_token() if csrf_token else '' }}";
</script>
<script src="{{ url_for('static', filename='js/report_global_schedule.js') }}" defer></script>
{% endblock %}