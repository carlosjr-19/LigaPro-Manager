{% extends "base.html" %}
{% block title %}{{ league.name }} - LigaPro Manager{% endblock %}

{% block content %}
{% set is_premium = league.owner.is_active_premium %}
<div class="min-h-screen">
    <!-- Header -->
    <header class="bg-card border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 md:px-6 py-4">
            <a href="{{ url_for('main.dashboard') }}"
                class="inline-flex items-center gap-2 text-white/60 hover:text-white mb-4">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 md:gap-0 text-center md:text-left">
                <div>
                    <h1 class="text-3xl font-bold">{{ league.name }}</h1>
                    <p class="text-white/60">{{ teams|length }} / {{ league.max_teams }} equipos</p>
                </div>
                <a href="{{ url_for('team.create_team', league_id=league.id) }}" class="btn-primary">
                    <i class="fas fa-plus mr-2"></i>Añadir Equipo
                </a>
            </div>
        </div>
    </header>

    <!-- Tabs -->
    <div class="bg-card border-b border-white/10 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex gap-1 overflow-x-auto">
                <button onclick="showTab('panel')" class="tab-btn active" data-tab="panel">
                    <i class="fas fa-columns mr-2"></i>Panel
                </button>
                <button onclick="showTab('standings')" class="tab-btn" data-tab="standings">
                    <i class="fas fa-trophy mr-2"></i>Tabla
                </button>
                <button onclick="showTab('teams')" class="tab-btn" data-tab="teams">
                    <i class="fas fa-users mr-2"></i>Equipos
                </button>
                <button onclick="showTab('matches')" class="tab-btn" data-tab="matches">
                    <i class="fas fa-calendar mr-2"></i>Partidos
                </button>
                <button onclick="showTab('stats')" class="tab-btn" data-tab="stats">
                    <i class="fas fa-chart-bar mr-2"></i>Estadísticas
                </button>
                <button onclick="showTab('playoff')" class="tab-btn" data-tab="playoff">
                    <i class="fas fa-bolt mr-2"></i>Liguilla
                </button>
                <button onclick="showTab('settings')" class="tab-btn" data-tab="settings">
                    <i class="fas fa-cog mr-2"></i>Config
                </button>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/league_detail.css') }}">

    <!-- Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Panel Tab -->
        <div id="panel" class="tab-content active">
            <!-- Top 5 Standings -->
            <div class="mb-8 p-4 bg-white/5 rounded-lg border border-white/10 relative">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg flex items-center gap-2">
                        <i class="fas fa-trophy text-primary"></i> Liderazgo (Top 5)
                    </h3>
                    {% if current_user.role == 'owner' %}
                    <button onclick="openShareModal()"
                        class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition-colors">
                        <i class="fas fa-download mr-1"></i>Descargar
                    </button>
                    {% endif %}
                </div>
                <!-- ... table ... -->

                <!-- ... table ... -->

                <div class="overflow-x-auto">
                    <table class="w-full text-sm min-w-[300px]">
                        <thead>
                            <tr class="border-b border-white/10 text-white/60 text-xs uppercase">
                                <th class="text-left py-2">#</th>
                                <th class="text-left py-2">Equipo</th>
                                <th class="text-center py-2">PJ</th>
                                <th class="text-center py-2">PTS</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in standings[:5] %}
                            <tr class="border-b border-white/5 hover:bg-white/5">
                                <td class="py-2 text-primary font-bold">{{ loop.index }}</td>
                                <td class="py-2 flex items-center gap-2">
                                    {% if s.team.shield_url %}
                                    <img src="{{ s.team.shield_url }}" class="w-6 h-6 rounded object-cover">
                                    {% endif %}
                                    {{ s.team.name }}
                                </td>
                                <td class="text-center py-2">{{ s.played }}</td>
                                <td class="text-center py-2 font-bold">{{ s.points }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="py-4 text-center text-white/40">Sin datos</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        </tbody>
                    </table>
                </div>
            </div>


            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Recent Matches -->
                <div class="bg-white/5 rounded-lg border border-white/10 p-4">
                    <h3 class="font-bold mb-4 text-lg flex items-center gap-2">
                        <i class="fas fa-history text-blue-400"></i> Últimos Resultados
                    </h3>
                    <div class="space-y-3">
                        {% for match in recent_matches %}
                        <div
                            class="flex justify-between items-center text-sm border-b border-white/5 pb-2 last:border-0">
                            <div class="flex-1 text-right flex items-center justify-end gap-2">
                                {{ teams_dict[match.home_team_id].name }}
                                {% if teams_dict[match.home_team_id].shield_url %}
                                <img src="{{ teams_dict[match.home_team_id].shield_url }}"
                                    class="w-5 h-5 rounded object-cover flex-shrink-0">
                                {% endif %}
                                {% if teams_dict[match.home_team_id].is_deleted %}<span
                                    class="text-red-400 text-xs">(Eliminado)</span>{% endif %}
                            </div>
                            <div class="px-3 font-bold bg-white/10 rounded mx-2 py-1 flex-shrink-0">
                                {{ match.home_score }} - {{ match.away_score }}
                            </div>
                            <div class="flex-1 text-left flex items-center gap-2">
                                {% if teams_dict[match.away_team_id].shield_url %}
                                <img src="{{ teams_dict[match.away_team_id].shield_url }}"
                                    class="w-5 h-5 rounded object-cover flex-shrink-0">
                                {% endif %}
                                {{ teams_dict[match.away_team_id].name }}
                                {% if teams_dict[match.away_team_id].is_deleted %}<span
                                    class="text-red-400 text-xs">(Eliminado)</span>{% endif %}
                            </div>
                        </div>
                        {% else %}
                        <p class="text-white/40 text-sm italic">No hay resultados recientes.</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Upcoming Matches -->
                <div class="bg-white/5 rounded-lg border border-white/10 p-4">
                    <h3 class="font-bold mb-4 text-lg flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-green-400"></i> Próximos Partidos
                    </h3>
                    <div class="space-y-3">
                        {% for match in upcoming_matches %}
                        <div class="text-sm border-b border-white/5 pb-2 last:border-0">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-white/60 text-xs">{{ match.match_date.strftime('%d/%m %I:%M %p')
                                    }}</span>
                            </div>
                            <div class="flex justify-between items-center font-medium gap-2">
                                <span class="flex-1 text-right flex items-center justify-end gap-2">
                                    {{ teams_dict[match.home_team_id].name }}
                                    {% if teams_dict[match.home_team_id].shield_url %}
                                    <img src="{{ teams_dict[match.home_team_id].shield_url }}"
                                        class="w-5 h-5 rounded object-cover flex-shrink-0">
                                    {% endif %}
                                    {% if teams_dict[match.home_team_id].is_deleted %}<span
                                        class="text-red-400 text-xs">(Eliminado)</span>{% endif %}
                                </span>
                                <span class="text-white/40 text-xs flex-shrink-0">vs</span>
                                <span class="flex-1 text-left flex items-center gap-2">
                                    {% if teams_dict[match.away_team_id].shield_url %}
                                    <img src="{{ teams_dict[match.away_team_id].shield_url }}"
                                        class="w-5 h-5 rounded object-cover flex-shrink-0">
                                    {% endif %}
                                    {{ teams_dict[match.away_team_id].name }}
                                    {% if teams_dict[match.away_team_id].is_deleted %}<span
                                        class="text-red-400 text-xs">(Eliminado)</span>{% endif %}
                                </span>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-white/40 text-sm italic">No hay partidos programados.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Top Scorers -->
                <div class="bg-white/5 rounded-lg border border-white/10 p-4">
                    <h3 class="font-bold mb-4 text-lg flex items-center gap-2">
                        <i class="fas fa-futbol text-yellow-400"></i> Top 3 Goleadores
                    </h3>
                    <div class="space-y-2">
                        {% for stat in top_scorers[:3] %}
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center overflow-hidden">
                                    {% if stat.photo_url %}
                                    <img src="{{ stat.photo_url }}" class="w-full h-full object-cover">
                                    {% else %}
                                    <i class="fas fa-user text-white/40"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <p class="font-bold">{{ stat.player_name }}</p>
                                    <p class="text-xs text-white/40">{{ stat.team.name }}</p>
                                </div>
                            </div>
                            <span class="font-bold text-primary">{{ stat.value }}</span>
                        </div>
                        {% else %}
                        <p class="text-white/40 text-sm italic">Sin registros.</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Top Keepers -->
                <div class="bg-white/5 rounded-lg border border-white/10 p-4">
                    <h3 class="font-bold mb-4 text-lg flex items-center gap-2">
                        <i class="fas fa-hand-paper text-red-400"></i> Top 3 Arqueros
                    </h3>
                    <div class="space-y-2">
                        {% for stat in top_goalkeepers[:3] %}
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center overflow-hidden">
                                    {% if stat.photo_url %}
                                    <img src="{{ stat.photo_url }}" class="w-full h-full object-cover">
                                    {% else %}
                                    <i class="fas fa-user text-white/40"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <p class="font-bold">{{ stat.player_name }}</p>
                                    <p class="text-xs text-white/40">{{ stat.team.name }}</p>
                                </div>
                            </div>
                            <span class="font-bold text-red-400">{{ stat.value }}</span>
                        </div>
                        {% else %}
                        <p class="text-white/40 text-sm italic">Sin registros.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Standings Tab -->
        <div id="standings" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">Tabla de Posiciones</h2>
            {% if standings %}
            <div class="card overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10 text-white/60 text-xs uppercase">
                            <th class="text-left p-3">#</th>
                            <th class="text-left p-3">Equipo</th>
                            <th class="text-center p-3">PJ</th>
                            <th class="text-center p-3">G</th>
                            <th class="text-center p-3">E</th>
                            <th class="text-center p-3">P</th>
                            <th class="text-center p-3">GF</th>
                            <th class="text-center p-3">GC</th>
                            <th class="text-center p-3">DG</th>
                            <th class="text-center p-3 text-primary">PTS</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in standings %}
                        <tr class="border-b border-white/5 hover:bg-white/5">
                            <td class="p-3 font-bold text-primary">{{ loop.index }}</td>
                            <td class="p-3">
                                <div class="flex items-center gap-3">
                                    {% if s.team.shield_url %}
                                    <img src="{{ s.team.shield_url }}" class="w-8 h-8 rounded object-cover">
                                    {% else %}
                                    <div class="w-8 h-8 bg-white/10 rounded flex items-center justify-center">
                                        <i class="fas fa-shield-alt text-white/40"></i>
                                    </div>
                                    {% endif %}
                                    <span class="font-medium">{{ s.team.name }}</span>
                                </div>
                            </td>
                            <td class="p-3 text-center">{{ s.played }}</td>
                            <td class="p-3 text-center">{{ s.won }}</td>
                            <td class="p-3 text-center">{{ s.drawn }}</td>
                            <td class="p-3 text-center">{{ s.lost }}</td>
                            <td class="p-3 text-center">{{ s.goals_for }}</td>
                            <td class="p-3 text-center">{{ s.goals_against }}</td>
                            <td class="p-3 text-center">{{ s.goal_difference }}</td>
                            <td class="p-3 text-center font-bold text-primary">{{ s.points }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="card text-center py-12">
                <p class="text-white/60">No hay datos en la tabla de posiciones</p>
                <p class="text-white/40 text-sm mt-2">Registra resultados de partidos para ver estadísticas</p>
            </div>
            {% endif %}
        </div>

        <!-- Teams Tab -->
        <div id="teams" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">Equipos de la Liga</h2>
            {% if teams %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for team in teams %}
                <a href="{{ url_for('team.team_detail', team_id=team.id) }}"
                    class="card hover:border-white/20 transition-colors {% if team.is_hidden %}opacity-50{% endif %}">
                    <div class="flex items-center gap-4 mb-4">
                        {% if team.shield_url %}
                        <img src="{{ team.shield_url }}" class="w-16 h-16 rounded object-cover">
                        {% else %}
                        <div class="w-16 h-16 bg-white/10 rounded flex items-center justify-center">
                            <i class="fas fa-shield-alt text-2xl text-white/40"></i>
                        </div>
                        {% endif %}
                        <div>
                            <h3 class="text-xl font-bold">
                                {{ team.name }}
                                {% if team.is_hidden %}
                                <span
                                    class="bg-orange-500/20 text-orange-400 text-xs px-2 py-0.5 rounded ml-2">OCULTO</span>
                                {% endif %}
                            </h3>
                            {% if team.captain_name %}
                            <p class="text-white/60 text-sm">Cap: {{ team.captain_name }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <p class="text-white/40 text-sm">{{ team.players|length }} jugadores</p>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="card text-center py-12">
                <i class="fas fa-users text-4xl text-white/20 mb-4"></i>
                <p class="text-white/60 mb-4">No hay equipos registrados</p>
                <a href="{{ url_for('team.create_team', league_id=league.id) }}" class="btn-primary">
                    Añadir primer equipo
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Matches Tab -->
        <div id="matches" class="tab-content">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 md:gap-0">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-bold">Partidos</h2>
                    <!-- View Toggles -->
                    <div class="flex bg-white/5 rounded-lg p-1 border border-white/10">
                        <button onclick="toggleMatchView('list')" id="btn-view-list"
                            class="px-3 py-1 rounded text-sm font-medium transition-colors bg-primary text-white">
                            <i class="fas fa-list mr-2"></i>Lista
                        </button>
                        <button onclick="toggleMatchView('matrix')" id="btn-view-matrix"
                            class="px-3 py-1 rounded text-sm font-medium transition-colors text-white/60 hover:text-white">
                            <i class="fas fa-th mr-2"></i>Cuadro
                        </button>
                        <button onclick="toggleMatchView('dates')" id="btn-view-dates"
                            class="px-3 py-1 rounded text-sm font-medium transition-colors text-white/60 hover:text-white">
                            <i class="fas fa-calendar-day mr-2"></i>Fechas
                        </button>
                    </div>
                </div>

                <a href="{{ url_for('match.create_match', league_id=league.id) }}" class="btn-primary">
                    <i class="fas fa-plus mr-2"></i>Programar Partido
                </a>
            </div>

            <div id="matches-list-view">

                {% if matches_pagination and matches_pagination.items %}
                <div class="space-y-4">
                    {% for match in matches_pagination.items %}
                    <div class="card">
                        <div class="flex flex-col md:flex-row md:items-center gap-4">
                            <div class="flex-1">
                                <p class="text-white/60 text-sm mb-4">
                                    {{ match.match_date.strftime('%d/%m/%Y %I:%M %p') }}
                                    {% if match.court %}
                                    <span class="ml-2 text-blue-400 font-medium"><i
                                            class="fas fa-map-marker-alt mr-1"></i>{{ match.court.name }}</span>
                                    {% endif %}
                                </p>
                                <div class="flex items-center justify-between gap-4">
                                    <div class="flex items-center gap-3 flex-1 justify-end">
                                        <span class="font-bold text-right">
                                            {{ teams_dict[match.home_team_id].name }}
                                            {% if teams_dict[match.home_team_id].is_deleted %}<span
                                                class="text-red-400 text-xs">(Eliminado)</span>{% endif %}
                                        </span>
                                        {% if teams_dict[match.home_team_id].shield_url %}
                                        <img src="{{ teams_dict[match.home_team_id].shield_url }}"
                                            class="w-8 h-8 rounded object-cover bg-white/5">
                                        {% else %}
                                        <div class="w-8 h-8 rounded bg-white/10 flex items-center justify-center">
                                            <i class="fas fa-shield-alt text-xs text-white/40"></i>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="flex items-center gap-2 min-w-[80px] justify-center">
                                        {% if match.is_completed %}
                                        <span class="text-2xl font-bold text-primary">{{ match.home_score }}</span>
                                        <span class="text-white/40">-</span>
                                        <span class="text-2xl font-bold text-primary">{{ match.away_score }}</span>
                                        {% else %}
                                        <span class="text-white/40 text-sm">vs</span>
                                        {% endif %}
                                    </div>

                                    <div class="flex items-center gap-3 flex-1">
                                        {% if teams_dict[match.away_team_id].shield_url %}
                                        <img src="{{ teams_dict[match.away_team_id].shield_url }}"
                                            class="w-8 h-8 rounded object-cover bg-white/5">
                                        {% else %}
                                        <div class="w-8 h-8 rounded bg-white/10 flex items-center justify-center">
                                            <i class="fas fa-shield-alt text-xs text-white/40"></i>
                                        </div>
                                        {% endif %}
                                        <span class="font-bold">
                                            {{ teams_dict[match.away_team_id].name }}
                                            {% if teams_dict[match.away_team_id].is_deleted %}<span
                                                class="text-red-400 text-xs">(Eliminado)</span>{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                {% if match.is_completed %}
                                <span class="bg-green-500/20 text-green-400 px-3 py-1 rounded text-xs">Finalizado</span>
                                <a href="{{ url_for('match.update_match_result', match_id=match.id) }}"
                                    class="text-blue-400 hover:text-blue-300 text-sm p-2" title="Editar Resultado">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                                {% else %}
                                <a href="{{ url_for('match.edit_match', match_id=match.id) }}"
                                    class="text-white/40 hover:text-white transition-colors p-2"
                                    title="Editar Detalles">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                                <a href="{{ url_for('match.update_match_result', match_id=match.id) }}"
                                    class="btn-secondary text-sm">
                                    Registrar Resultado
                                </a>
                                <form method="POST" action="{{ url_for('match.delete_match', match_id=match.id) }}"
                                    class="inline"
                                    onsubmit="return confirm('¿Estás seguro de eliminar este partido?');">
                                    <button type="submit" class="text-white/40 hover:text-red-500 transition-colors p-2"
                                        title="Eliminar Partido">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Pagination Controls -->
                    <div class="flex justify-between items-center mt-6 pt-4 border-t border-white/10">
                        <div>
                            {% if matches_pagination.has_prev %}
                            <a href="{{ url_for('league.league_detail', league_id=league.id, page=matches_pagination.prev_num, _anchor='matches') }}"
                                class="btn-secondary text-sm">
                                <i class="fas fa-chevron-left mr-2"></i>Anterior
                            </a>
                            {% else %}
                            <span class="btn-secondary text-white/20 cursor-not-allowed text-sm">
                                <i class="fas fa-chevron-left mr-2"></i>Anterior
                            </span>
                            {% endif %}
                        </div>

                        <span class="text-white/40 text-sm">
                            Página {{ matches_pagination.page }} de {{ matches_pagination.pages }}
                        </span>

                        <div>
                            {% if matches_pagination.has_next %}
                            <a href="{{ url_for('league.league_detail', league_id=league.id, page=matches_pagination.next_num, _anchor='matches') }}"
                                class="btn-secondary text-sm">
                                Siguiente<i class="fas fa-chevron-right ml-2"></i>
                            </a>
                            {% else %}
                            <span class="btn-secondary text-white/20 cursor-not-allowed text-sm">
                                Siguiente<i class="fas fa-chevron-right ml-2"></i>
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card text-center py-12">
                    <i class="fas fa-calendar text-4xl text-white/20 mb-4"></i>
                    <p class="text-white/60 mb-4">No hay partidos programados</p>
                    <a href="{{ url_for('match.create_match', league_id=league.id) }}" class="btn-primary">
                        Programar primer partido
                    </a>
                </div>
                {% endif %}
            </div> <!-- End matches-list-view -->

            <!-- Dates View -->
            <div id="matches-dates-view" class="hidden space-y-4">
                {% if matches_by_date %}
                {% for date, day_matches in matches_by_date.items() %}
                <div class="border border-white/10 rounded-xl overflow-hidden bg-white/5">
                    <button onclick="toggleDateCollapse('date-{{ loop.index }}')"
                        class="w-full flex items-center justify-between p-4 hover:bg-white/5 transition-colors text-left">
                        <div class="flex items-center gap-3">
                            <div
                                class="bg-primary/20 text-primary w-10 h-10 rounded-lg flex flex-col items-center justify-center font-bold">
                                <span class="text-xs uppercase leading-none">{{ spanish_months_short[date.month]
                                    }}</span>
                                <span class="text-lg leading-none">{{ date.day }}</span>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg">{{ date.day }} de {{ spanish_months[date.month] }} de {{
                                    date.year }}</h4>
                                <p class="text-white/40 text-sm italic">{{ day_matches|length }} partidos</p>
                            </div>
                        </div>
                        <i id="icon-date-{{ loop.index }}"
                            class="fas fa-chevron-down text-white/40 transition-transform"></i>
                    </button>
                    <div id="date-{{ loop.index }}" class="hidden border-t border-white/5 bg-black/20 p-4 space-y-3">
                        {% for match in day_matches %}
                        <div
                            class="flex flex-col md:flex-row md:items-center gap-4 border-b border-white/5 last:border-0 pb-3 last:pb-0">
                            <div class="flex-1">
                                <p class="text-white/60 text-xs mb-2">
                                    {{ match.match_date.strftime('%I:%M %p') }}
                                    {% if match.court %}
                                    <span class="ml-2 text-blue-400"><i class="fas fa-map-marker-alt mr-1"></i>{{
                                        match.court.name }}</span>
                                    {% endif %}
                                </p>
                                <div class="flex items-center justify-between gap-4">
                                    <div class="flex items-center gap-2 flex-1 justify-end">
                                        <span class="font-bold text-sm text-right leading-tight">
                                            {{ teams_dict[match.home_team_id].name }}
                                        </span>
                                        {% if teams_dict[match.home_team_id].shield_url %}
                                        <img src="{{ teams_dict[match.home_team_id].shield_url }}"
                                            class="w-6 h-6 rounded object-cover">
                                        {% else %}
                                        <div
                                            class="w-6 h-6 rounded bg-white/10 flex items-center justify-center text-[10px]">
                                            <i class="fas fa-shield-alt text-white/40"></i>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center gap-2 min-w-[60px] justify-center">
                                        {% if match.is_completed %}
                                        <span class="font-bold text-primary">{{ match.home_score }} - {{
                                            match.away_score }}</span>
                                        {% else %}
                                        <span class="text-white/40 text-xs">vs</span>
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center gap-2 flex-1">
                                        {% if teams_dict[match.away_team_id].shield_url %}
                                        <img src="{{ teams_dict[match.away_team_id].shield_url }}"
                                            class="w-6 h-6 rounded object-cover">
                                        {% else %}
                                        <div
                                            class="w-6 h-6 rounded bg-white/10 flex items-center justify-center text-[10px]">
                                            <i class="fas fa-shield-alt text-white/40"></i>
                                        </div>
                                        {% endif %}
                                        <span class="font-bold text-sm leading-tight">
                                            {{ teams_dict[match.away_team_id].name }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                {% if match.is_completed %}
                                <span
                                    class="bg-green-500/20 text-green-400 px-2 py-0.5 rounded text-[10px]">Finalizado</span>
                                {% endif %}
                                <a href="{{ url_for('match.update_match_result', match_id=match.id) }}"
                                    class="text-blue-400 hover:text-blue-300 text-xs">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="card text-center py-12">
                    <i class="fas fa-calendar-day text-4xl text-white/20 mb-4"></i>
                    <p class="text-white/60">No hay partidos para agrupar por fechas</p>
                </div>
                {% endif %}
            </div> <!-- End matches-dates-view -->

            <!-- Matrix View -->
            <div id="matches-matrix-view" class="hidden overflow-x-auto pb-4">
                {% if teams %}
                {% if num_vueltas > 1 %}
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    {% for r in range(1, num_vueltas + 1) %}
                    <button onclick="showMatrixRound({{ r }})" id="btn-matrix-round-{{ r }}"
                        class="px-4 py-2 rounded-full text-sm font-bold border border-white/10 transition-colors {% if r == 1 %}bg-primary text-white{% else %}bg-white/5 text-white/60 hover:bg-white/10{% endif %} whitespace-nowrap">
                        Vuelta {{ r }}
                    </button>
                    {% endfor %}
                </div>
                {% endif %}

                {% for r in range(1, num_vueltas + 1) %}
                <div id="matrix-round-{{ r }}" class="matrix-round-container {% if r != 1 %}hidden{% endif %}">
                    <table class="w-full border-collapse min-w-[800px]">
                        <thead>
                            <tr>
                                <th class="p-2 border border-white/10 bg-white/5 sticky left-0 z-10 w-40"></th>
                                {% for team in scheduling_teams %}
                                <th class="p-2 border border-white/10 bg-white/5 text-center min-w-[120px]">
                                    <div class="flex flex-col items-center">
                                        {% if team.shield_url %}
                                        <img src="{{ team.shield_url }}" class="w-8 h-8 rounded object-cover mb-1">
                                        {% else %}
                                        <div class="w-8 h-8 bg-white/10 rounded flex items-center justify-center mb-1">
                                            <i class="fas fa-shield-alt text-xs text-white/40"></i>
                                        </div>
                                        {% endif %}
                                        <span
                                            class="text-xs font-bold whitespace-nowrap overflow-hidden text-ellipsis max-w-[110px]">{{
                                            team.name }}</span>
                                    </div>
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for home in scheduling_teams %}
                            <tr>
                                <th
                                    class="p-2 border border-white/10 bg-white/5 text-left min-w-[150px] sticky left-0 z-10">
                                    <div class="flex items-center gap-2">
                                        {% if home.shield_url %}
                                        <img src="{{ home.shield_url }}" class="w-6 h-6 rounded object-cover">
                                        {% else %}
                                        <div class="w-6 h-6 bg-white/10 rounded flex items-center justify-center">
                                            <i class="fas fa-shield-alt text-xs text-white/40"></i>
                                        </div>
                                        {% endif %}
                                        <span
                                            class="text-sm font-bold whitespace-nowrap overflow-hidden text-ellipsis max-w-[120px]">{{
                                            home.name }}</span>
                                    </div>
                                </th>
                                {% for away in scheduling_teams %}
                                {% set cell = round_matrices[r][home.id][away.id] %}
                                <td
                                    class="p-0 border border-white/10 text-center relative hover:bg-white/5 transition-colors h-20">
                                    {% if cell.status == 'cnt_play' %}
                                    <div class="w-full h-full bg-white/5 flex items-center justify-center">
                                        <div class="w-full h-px bg-white/10 rotate-45 transform scale-150"></div>
                                    </div>
                                    {% else %}
                                    <button type="button" onclick='openMatrixModal({{ cell | tojson | safe }})'
                                        class="w-full h-full flex flex-col items-center justify-center p-1 group">

                                        {% if cell.status == 'completed' %}
                                        {% set score_color = 'text-green-400' if cell.match.home_score >
                                        cell.match.away_score else 'text-red-400' if cell.match.home_score <
                                            cell.match.away_score else 'text-white' %} <span
                                            class="font-bold text-lg {{ score_color }} group-hover:scale-110 transition-transform">
                                            {{
                                            cell.match.home_score }} - {{ cell.match.away_score }}</span>
                                            {% if cell.match.is_completed %}
                                            <span class="text-[10px] text-green-400">Finalizado</span>
                                            {% endif %}
                                            <span class="text-xs text-white/40 mt-1">{{ cell.match.match_date_display
                                                }}</span>
                                            {% elif cell.status == 'scheduled' %}
                                            <span class="text-sm text-blue-400 font-bold group-hover:text-blue-300">{{
                                                cell.match.match_date_display }}</span>
                                            {% if cell.match.match_time_display and '00:00' not in
                                            cell.match.match_time_display
                                            %}
                                            <span class="text-[10px] text-white/40">{{ cell.match.match_time_display
                                                }}</span>
                                            {% endif %}
                                            <i
                                                class="fas fa-pencil-alt text-[10px] text-white/0 group-hover:text-white/40 mt-1 transition-colors"></i>
                                            {% else %}
                                            <span
                                                class="text-white/20 text-2xl group-hover:text-white/60 transition-colors">-</span>
                                            {% endif %}
                                    </button>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-12 text-white/40">
                    <p>No hay suficientes equipos para mostrar el cuadro.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Stats Tab -->
        <div id="stats" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">Estadísticas de la Temporada</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Top Scorers -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-primary"><i class="fas fa-futbol mr-2"></i>Goleadores</h3>
                    </div>

                    {% if current_user.role == 'owner' %}
                    <div class="mb-6 bg-white/5 p-4 rounded-lg border border-white/10">
                        <h3 class="font-bold mb-4 text-sm uppercase text-primary">Agregar Goleador</h3>
                        <form method="POST" action="{{ url_for('stats.add_stat', league_id=league.id) }}"
                            class="flex flex-col sm:flex-row gap-4 items-stretch sm:items-end">
                            {{ stat_form.hidden_tag() }}
                            <input type="hidden" name="stat_type" value="goals">
                            <!-- Photo URL will be auto-filled from player selection in ligapro_manager -->
                            <div class="flex-1">
                                <label class="block text-xs uppercase text-white/40 mb-1">Equipo</label>
                                {{ stat_form.team_id(class="input-field text-sm team-select",
                                data_target="player-select-goals") }}
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs uppercase text-white/40 mb-1">Jugador</label>
                                <!-- Use dynamic select -->
                                <select name="player_name" id="player-select-goals" class="input-field text-sm"
                                    required>
                                    <option value="">Selecciona un equipo primero</option>
                                </select>
                            </div>
                            <div class="w-24">
                                <label class="block text-xs uppercase text-white/40 mb-1">Goles</label>
                                {{ stat_form.value(class="input-field text-sm", placeholder="0") }}
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-plus"></i>
                            </button>
                        </form>
                    </div>
                    {% endif %}

                    {% if top_scorers %}
                    <div class="card overflow-x-auto p-0">
                        <table class="w-full min-w-[500px]">
                            <thead class="bg-white/5">
                                <tr class="text-left text-xs uppercase text-white/60">
                                    <th class="p-3">#</th>
                                    <th class="p-3">Jugador</th>
                                    <th class="p-3">Equipo</th>
                                    <th class="p-3 text-right">Goles</th>
                                    {% if current_user.role == 'owner' %}<th class="p-3"></th>{% endif %}
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5">
                                {% for stat in top_scorers %}
                                <tr class="hover:bg-white/5">
                                    <td class="p-3 font-bold text-white/40">{{ loop.index }}</td>
                                    <td class="p-3 font-medium">{{ stat.player_name }}</td>
                                    <td class="p-3 text-sm text-white/60">{{ stat.team.name }}</td>
                                    <td class="p-3 text-right font-bold text-primary">{{ stat.value }}</td>
                                    {% if current_user.role == 'owner' %}
                                    <td class="p-3 text-right flex justify-end gap-2">
                                        <a href="{{ url_for('stats.edit_stat', stat_id=stat.id) }}"
                                            class="text-blue-400 hover:text-blue-300">
                                            <i class="fas fa-pencil-alt"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('stats.delete_stat', stat_id=stat.id) }}"
                                            onsubmit="return confirm('¿Eliminar?')">
                                            <button type="submit" class="text-red-500 hover:text-red-400">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="card text-center py-8 text-white/40">
                        <p>No hay goleadores registrados</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Goalkeepers -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-blue-400"><i class="fas fa-hand-paper mr-2"></i>Arquero Menos
                            Goleado</h3>
                    </div>

                    {% if current_user.role == 'owner' %}
                    <div class="mb-6 bg-white/5 p-4 rounded-lg border border-white/10">
                        <h3 class="font-bold mb-4 text-sm uppercase text-primary">Agregar Arquero</h3>
                        <form method="POST" action="{{ url_for('stats.add_stat', league_id=league.id) }}"
                            class="flex flex-col sm:flex-row gap-4 items-stretch sm:items-end">
                            {{ stat_form.hidden_tag() }}
                            <input type="hidden" name="stat_type" value="conceded">
                            <!-- Photo URL will be auto-filled from player selection in ligapro_manager -->
                            <div class="flex-1">
                                <label class="block text-xs uppercase text-white/40 mb-1">Equipo</label>
                                {{ stat_form.team_id(class="input-field text-sm team-select",
                                data_target="player-select-keeper") }}
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs uppercase text-white/40 mb-1">Portero</label>
                                <select name="player_name" id="player-select-keeper" class="input-field text-sm"
                                    required>
                                    <option value="">Selecciona un equipo primero</option>
                                </select>
                            </div>
                            <div class="w-24">
                                <label class="block text-xs uppercase text-white/40 mb-1">Recibidos</label>
                                {{ stat_form.value(class="input-field text-sm", placeholder="0") }}
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-plus"></i>
                            </button>
                        </form>
                    </div>
                    {% endif %}

                    {% if top_goalkeepers %}
                    <div class="card overflow-x-auto p-0">
                        <table class="w-full min-w-[500px]">
                            <thead class="bg-white/5">
                                <tr class="text-left text-xs uppercase text-white/60">
                                    <th class="p-3">#</th>
                                    <th class="p-3">Arquero</th>
                                    <th class="p-3">Equipo</th>
                                    <th class="p-3 text-right">Goles C.</th>
                                    {% if current_user.role == 'owner' %}<th class="p-3"></th>{% endif %}
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5">
                                {% for stat in top_goalkeepers %}
                                <tr class="hover:bg-white/5">
                                    <td class="p-3 font-bold text-white/40">{{ loop.index }}</td>
                                    <td class="p-3 font-medium">{{ stat.player_name }}</td>
                                    <td class="p-3 text-sm text-white/60">{{ stat.team.name }}</td>
                                    <td class="p-3 text-right font-bold text-blue-400">{{ stat.value }}</td>
                                    {% if current_user.role == 'owner' %}
                                    <td class="p-3 text-right flex justify-end gap-2">
                                        <a href="{{ url_for('stats.edit_stat', stat_id=stat.id) }}"
                                            class="text-blue-400 hover:text-blue-300">
                                            <i class="fas fa-pencil-alt"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('stats.delete_stat', stat_id=stat.id) }}"
                                            onsubmit="return confirm('¿Eliminar?')">
                                            <button type="submit" class="text-red-500 hover:text-red-400">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="card text-center py-8 text-white/40">
                        <p>No hay estadísticas de arqueros</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Playoff Tab -->
        <div id="playoff" class="tab-content">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 md:gap-0">
                <h2 class="text-2xl font-bold">Liguilla / Playoffs</h2>
                <div class="flex gap-2">
                    {% if has_playoffs %}
                    <form method="POST" action="{{ url_for('match.reset_playoffs', league_id=league.id) }}"
                        class="inline"
                        onsubmit="return confirm('⚠️ ¿Estás seguro de BORRAR toda la liguilla? Se perderán todos los partidos de eliminatoria.')">
                        <button type="submit"
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold transition-colors">
                            <i class="fas fa-trash mr-2"></i>Borrar Liguilla
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('match.advance_playoff_round', league_id=league.id) }}"
                        class="inline">
                        <button type="submit" class="btn-secondary">
                            <i class="fas fa-forward mr-2"></i>Avanzar Ronda
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>

            {% if has_playoffs %}
            <div class="flex justify-center mb-6">
                <div class="flex bg-white/5 rounded-lg p-1 border border-white/10">
                    <button onclick="togglePlayoffView('list')" id="btn-playoff-list"
                        class="px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-primary text-white shadow-lg shadow-primary/20">
                        <i class="fas fa-list mr-2"></i>Lista
                    </button>
                    <button onclick="togglePlayoffView('bracket')" id="btn-playoff-bracket"
                        class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-white/60 hover:text-white">
                        <i class="fas fa-sitemap mr-2"></i>Llaves
                    </button>
                </div>
            </div>
            {% endif %}

            {% if not has_playoffs %}
            <div class="card text-center py-12">
                <i class="fas fa-bolt text-4xl text-white/20 mb-4"></i>
                <p class="text-white/60 mb-2">La liguilla aún no ha sido generada</p>
                <p class="text-white/40 text-sm mb-6">Tienes {{ teams|length }} equipos en la liga</p>

                {% if teams|length >= 5 %}
                <div class="flex flex-col gap-4 justify-center items-center">
                    <form method="POST" action="{{ url_for('match.generate_playoffs', league_id=league.id) }}"
                        class="flex flex-col items-center gap-6">
                        <div class="mb-4 text-left inline-block">
                            <label class="block text-sm text-white/60 mb-2">Formato de Eliminatorias:</label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="playoff_type" value="single" checked
                                        class="form-radio text-primary">
                                    <span>Partido Único</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 {% if current_user.is_active_premium %}cursor-pointer{% else %}opacity-50 cursor-not-allowed{% endif %}"
                                    title="{% if not current_user.is_active_premium %}Premium requerido{% endif %}">
                                    <input type="radio" name="playoff_type" value="double" {% if not
                                        current_user.is_active_premium %}disabled{% endif %}
                                        class="form-radio text-primary">
                                    <span>Ida y Vuelta (Premium)</span>
                                </label>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button type="submit" name="mode" value="corte_directo"
                                class="btn-primary w-full sm:w-auto">
                                <i class="fas fa-cut mr-2"></i>Corte Directo
                            </button>
                            {% if teams|length >= 6 %}
                            <button type="submit" name="mode" value="con_repechaje"
                                class="btn-secondary w-full sm:w-auto">
                                <i class="fas fa-random mr-2"></i>Con Repechaje
                            </button>
                            {% endif %}
                        </div>
                    </form>
                </div>
                {% else %}
                <p class="text-warning">Se necesitan al menos 5 equipos para generar la liguilla</p>
                {% endif %}
            </div>
            {% else %}
            <div id="playoff-list-view" class="space-y-8">
                {% for stage_name, stage_matches in [('repechaje', playoff_matches.repechaje), ('round_of_16',
                playoff_matches.round_of_16), ('quarterfinal',
                playoff_matches.quarterfinal), ('semifinal', playoff_matches.semifinal), ('final',
                playoff_matches.final)] %}
                {% if stage_matches %}
                <div>
                    <h3 class="text-xl mb-4 
                                    {% if stage_name == 'repechaje' %}text-warning{% endif %}
                                    {% if stage_name == 'quarterfinal' %}text-blue-400{% endif %}
                                    {% if stage_name == 'semifinal' %}text-primary{% endif %}
                                    {% if stage_name == 'final' %}text-yellow-400{% endif %}">
                        {% if stage_name == 'repechaje' %}⚡ Repechaje{% endif %}
                        {% if stage_name == 'quarterfinal' %}🏆 Cuartos de Final{% endif %}
                        {% if stage_name == 'semifinal' %}🔥 Semifinales{% endif %}
                        {% if stage_name == 'final' %}👑 Final{% endif %}
                    </h3>
                    <div class="space-y-3">
                        {% for match in stage_matches %}
                        <div class="card {% if stage_name == 'final' %}border-yellow-400/50{% endif %}">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 flex items-center gap-4">
                                    <span class="font-bold flex items-center gap-2">
                                        {% if teams_dict[match.home_team_id].shield_url %}
                                        <img src="{{ teams_dict[match.home_team_id].shield_url }}"
                                            class="w-6 h-6 rounded object-cover">
                                        {% endif %}
                                        {{ teams_dict[match.home_team_id].name }}
                                        {% if teams_dict[match.home_team_id].is_deleted %}<span
                                            class="text-red-400 text-xs">(Eliminado)</span>{% endif %}
                                    </span>
                                    {% if match.is_completed %}
                                    <span class="text-2xl font-bold text-primary">{{ match.home_score }}</span>
                                    <span class="text-white/40">-</span>
                                    <span class="text-2xl font-bold text-primary">{{ match.away_score }}</span>
                                    {% else %}
                                    <span class="text-white/40">vs</span>
                                    {% endif %}
                                    <span class="font-bold flex items-center gap-2">
                                        {{ teams_dict[match.away_team_id].name }}
                                        {% if teams_dict[match.away_team_id].shield_url %}
                                        <img src="{{ teams_dict[match.away_team_id].shield_url }}"
                                            class="w-6 h-6 rounded object-cover">
                                        {% endif %}
                                        {% if teams_dict[match.away_team_id].is_deleted %}<span
                                            class="text-red-400 text-xs">(Eliminado)</span>{% endif %}
                                    </span>
                                </div>
                                {% if match.is_completed %}
                                <span class="bg-success/20 text-success px-3 py-1 rounded text-xs">Finalizado</span>
                                <a href="{{ url_for('match.update_match_result', match_id=match.id) }}"
                                    class="text-blue-400 hover:text-blue-300 text-sm p-2" title="Editar Resultado">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                                {% else %}
                                <a href="{{ url_for('match.edit_match', match_id=match.id) }}"
                                    class="text-white/40 hover:text-white transition-colors p-2"
                                    title="Editar Detalles">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                                <a href="{{ url_for('match.update_match_result', match_id=match.id) }}"
                                    class="btn-secondary text-sm">Resultado</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <!-- Bracket View -->
            <div id="playoff-bracket-view" class="hidden">
                <div class="bracket-container p-4">
                    {% for stage in ['round_of_16', 'quarterfinal', 'semifinal', 'final'] %}
                    {% set stage_matches = playoff_matches[stage] %}
                    {% if stage_matches %}
                    <div class="bracket-column">
                        <h4 class="text-center text-[10px] uppercase tracking-widest text-white/40 mb-4">
                            {% if stage == 'round_of_16' %}Octavos{% endif %}
                            {% if stage == 'quarterfinal' %}Cuartos{% endif %}
                            {% if stage == 'semifinal' %}Semis{% endif %}
                            {% if stage == 'final' %}Final{% endif %}
                        </h4>
                        {% for match in stage_matches %}
                        <a href="{{ url_for('match.update_match_result', match_id=match.id) }}"
                            class="bracket-match group">
                            <div class="text-[10px] text-white/30 mb-2 flex justify-between">
                                <span>{{ match.match_date.strftime('%d/%m') }}</span>
                                {% if match.is_completed %}
                                <span class="text-success">FIN</span>
                                {% endif %}
                            </div>
                            <div
                                class="bracket-team {% if match.is_completed and match.home_score > match.away_score %}winner{% endif %}">
                                <div class="flex items-center gap-2 truncate pr-2">
                                    {% if teams_dict[match.home_team_id].shield_url %}
                                    <img src="{{ teams_dict[match.home_team_id].shield_url }}"
                                        class="w-4 h-4 rounded object-cover flex-shrink-0">
                                    {% endif %}
                                    <span class="truncate">{{ teams_dict[match.home_team_id].name }}</span>
                                </div>
                                <span class="bracket-score">{{ match.home_score if match.home_score is not none else '-'
                                    }}</span>
                            </div>
                            <div
                                class="bracket-team {% if match.is_completed and match.away_score > match.home_score %}winner{% endif %}">
                                <div class="flex items-center gap-2 truncate pr-2">
                                    {% if teams_dict[match.away_team_id].shield_url %}
                                    <img src="{{ teams_dict[match.away_team_id].shield_url }}"
                                        class="w-4 h-4 rounded object-cover flex-shrink-0">
                                    {% endif %}
                                    <span class="truncate">{{ teams_dict[match.away_team_id].name }}</span>
                                </div>
                                <span class="bracket-score">{{ match.away_score if match.away_score is not none else '-'
                                    }}</span>
                            </div>

                            <div class="mt-2 pt-2 border-t border-white/5 flex justify-center">
                                <span
                                    class="text-[10px] text-white/20 group-hover:text-primary transition-colors uppercase tracking-widest font-bold">
                                    <i class="fas fa-pencil-alt mr-1"></i> Editar / Resultado
                                </span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

                {% if playoff_matches.repechaje %}
                <div class="mt-8 border-t border-white/10 pt-6">
                    <h4 class="text-warning text-sm font-bold mb-4 uppercase tracking-wider">⚡ Fase de Repechaje</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for match in playoff_matches.repechaje %}
                        <a href="{{ url_for('match.update_match_result', match_id=match.id) }}"
                            class="card p-4 flex justify-between items-center shadow-lg hover:border-primary/50 hover:bg-white/5 transition-all group">
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2">
                                    {% if teams_dict[match.home_team_id].shield_url %}
                                    <img src="{{ teams_dict[match.home_team_id].shield_url }}"
                                        class="w-5 h-5 rounded object-cover">
                                    {% endif %}
                                    <span class="font-bold text-sm">{{ teams_dict[match.home_team_id].name }}</span>
                                </div>
                                <span class="bg-white/10 px-3 py-1 rounded font-bold text-primary">{{ match.home_score
                                    if match.is_completed else '-' }}</span>
                                <span class="text-white/20">vs</span>
                                <span class="bg-white/10 px-3 py-1 rounded font-bold text-primary">{{ match.away_score
                                    if match.is_completed else '-' }}</span>
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-sm">{{ teams_dict[match.away_team_id].name }}</span>
                                    {% if teams_dict[match.away_team_id].shield_url %}
                                    <img src="{{ teams_dict[match.away_team_id].shield_url }}"
                                        class="w-5 h-5 rounded object-cover">
                                    {% endif %}
                                </div>
                            </div>
                            <span
                                class="text-[10px] text-white/20 group-hover:text-primary transition-colors uppercase tracking-widest font-bold">
                                <i class="fas fa-pencil-alt mr-1"></i> Editar
                            </span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Regenerate Option -->
            <div class="mt-8 pt-8 border-t border-white/10">
                <form method="POST" action="{{ url_for('match.generate_playoffs', league_id=league.id) }}"
                    onsubmit="return confirm('¿Estás seguro? Esto eliminará la liguilla actual.')">
                    <input type="hidden" name="mode" value="{{ league.playoff_mode or 'corte_directo' }}">
                    <button type="submit" class="btn-secondary text-sm">
                        <i class="fas fa-redo mr-2"></i>Regenerar Liguilla
                    </button>
                </form>
            </div>
            {% endif %}
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">Configuración de la Liga</h2>

            <!-- Settings Form (Embedded) -->
            <div class="card bg-white/5 border-white/10 p-6">
                <!-- If form is submitted from here, it goes to edit_league -->
                <!-- If form is submitted from here, it goes to edit_league -->
                <form id="leagueSettingsForm" method="POST"
                    action="{{ url_for('league.edit_league', league_id=league.id) }}" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}

                    <!-- Basic Info (Always Editable) -->
                    <div class="mb-6">
                        <label class="block text-sm text-white/60 mb-2 uppercase tracking-wide">Nombre de la
                            Liga</label>
                        {{ form.name(class="input-field", placeholder="Nombre de tu liga") }}
                    </div>

                    <!-- Gameplay Settings (Points & Max Teams - Premium to Edit) -->
                    <div class="mb-6 p-4 rounded-xl border border-white/10 relative overflow-hidden bg-white/5">
                        {% if not current_user.is_active_premium %}
                        <div
                            class="absolute inset-0 bg-black/60 backdrop-blur-[1px] z-10 flex items-center justify-center">
                            <div class="text-center">
                                <i class="fas fa-lock text-yellow-500 text-2xl mb-2"></i>
                                <p class="text-white font-bold text-sm">Configuración Gameplay Premium</p>
                                <p class="text-white/40 text-xs mb-3">Actualiza para editar puntos y límites de equipos
                                </p>
                                <a href="{{ url_for('premium.premium') }}"
                                    class="text-xs bg-yellow-500 hover:bg-yellow-400 text-black px-3 py-1 rounded font-bold transition-colors">
                                    Mejorar
                                </a>
                            </div>
                        </div>
                        {% endif %}

                        <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-gamepad text-blue-400"></i> Configuración de Juego
                        </h3>

                        <div
                            class="mb-4 {% if not current_user.is_active_premium %}opacity-50 pointer-events-none{% endif %}">
                            <label class="block text-sm text-white/60 mb-2 uppercase tracking-wide">Máximo de
                                Equipos</label>
                            {{ form.max_teams(class="input-field", placeholder="Ej: 10") }}
                            {% if not current_user.is_active_premium %}
                            <p class="text-xs text-white/40 mt-1">Límite gratuito: 10 equipos</p>
                            {% endif %}
                        </div>

                        <div
                            class="mb-4 {% if not current_user.is_active_premium %}opacity-50 pointer-events-none{% endif %}">
                            <label class="block text-sm text-white/60 mb-2 uppercase tracking-wide">Número de Vueltas
                                (1-5)</label>
                            {{ form.num_vueltas(class="input-field", type="number", min="1", max="5") }}
                            {% if not current_user.is_active_premium %}
                            <p class="text-xs text-white/40 mt-1">Límite gratuito: 1 Vuelta</p>
                            {% endif %}
                        </div>

                        <div
                            class="grid grid-cols-1 md:grid-cols-2 gap-4 {% if not current_user.is_active_premium %}opacity-50 pointer-events-none{% endif %}">
                            <div>
                                <label class="block text-sm text-white/60 mb-2 uppercase tracking-wide">Pts
                                    Victoria</label>
                                {{ form.win_points(class="input-field") }}
                            </div>
                            <div>
                                <label class="block text-sm text-white/60 mb-2 uppercase tracking-wide">Pts
                                    Empate</label>
                                {{ form.draw_points(class="input-field") }}
                            </div>
                        </div>
                    </div>
            </div>
            </form>

            <!-- Court Settings (Outside main form) -->
            <div class="mb-8 p-4 rounded-xl border border-white/10 bg-white/5">
                <h3 class="text-sm font-bold text-green-400 mb-4 flex items-center gap-2">
                    <i class="fas fa-map-marker-alt"></i> Canchas
                </h3>

                <div class="space-y-3 mb-4">
                    {% for court in courts %}
                    <div class="bg-black/20 p-4 rounded-xl border border-white/5 space-y-4">
                        <form method="POST" action="{{ url_for('league.update_court', court_id=court.id) }}">
                            <div class="flex items-center justify-between mb-4">
                                <input type="text" name="court_name" value="{{ court.name }}"
                                    class="bg-transparent border-none text-white focus:ring-0 p-0 font-bold text-base"
                                    placeholder="Nombre de cancha">
                                <div class="flex gap-2">
                                    <button type="submit"
                                        class="text-blue-400 hover:text-blue-300 text-xs px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 transition-colors border border-white/10"
                                        title="Guardar cambios">
                                        <i class="fas fa-save mr-1"></i>Guardar
                                    </button>
                                    {% if current_user.role == 'owner' and courts|length > 1 %}
                                    <button form="delete-court-{{ court.id }}" type="submit"
                                        class="text-red-400 hover:text-red-300 text-xs px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 transition-colors border border-white/10"
                                        title="Eliminar cancha">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>

                            {% if current_user.is_active_premium %}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-white/5">
                                <div>
                                    <label class="block text-[10px] text-white/40 mb-1 uppercase tracking-widest">Color
                                        en Reporte</label>
                                    <div class="flex items-center gap-2">
                                        <input type="color" name="court_color" value="{{ court.color }}"
                                            class="w-10 h-8 p-1 rounded cursor-pointer bg-transparent border border-white/20">
                                        <span class="text-[10px] text-white/30">Color del título</span>
                                    </div>
                                </div>
                                <div>
                                    <label
                                        class="block text-[10px] text-white/40 mb-1 uppercase tracking-widest">Alineación</label>
                                    <div class="flex bg-black/20 rounded-lg p-1 border border-white/10 w-fit">
                                        <label class="cursor-pointer">
                                            <input type="radio" name="court_alignment" value="left" class="hidden peer"
                                                {% if court.alignment=='left' %}checked{% endif %}>
                                            <div
                                                class="px-3 py-1 rounded text-[10px] text-white/40 peer-checked:bg-primary peer-checked:text-white hover:bg-white/5 font-bold transition-all">
                                                IZQ</div>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="court_alignment" value="center"
                                                class="hidden peer" {% if court.alignment=='center' %}checked{% endif
                                                %}>
                                            <div
                                                class="px-3 py-1 rounded text-[10px] text-white/40 peer-checked:bg-primary peer-checked:text-white hover:bg-white/5 font-bold transition-all">
                                                CEN</div>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="court_alignment" value="right" class="hidden peer"
                                                {% if court.alignment=='right' %}checked{% endif %}>
                                            <div
                                                class="px-3 py-1 rounded text-[10px] text-white/40 peer-checked:bg-primary peer-checked:text-white hover:bg-white/5 font-bold transition-all">
                                                DER</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </form>

                        {% if current_user.role == 'owner' and courts|length > 1 %}
                        <form id="delete-court-{{ court.id }}" method="POST"
                            action="{{ url_for('league.delete_court', court_id=court.id) }}"
                            onsubmit="return confirm('¿Eliminar {{ court.name }}? No debe tener partidos asignados.')"
                            class="hidden">
                        </form>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                {% if current_user.role == 'owner' %}
                {% if current_user.is_active_premium %}
                {% if courts|length < 3 %} <form method="POST"
                    action="{{ url_for('league.add_court', league_id=league.id) }}" class="flex gap-2 items-center">
                    <input type="text" name="court_name" class="input-field text-sm py-1.5"
                        placeholder="Nombre nueva cancha" required>
                    <button type="submit" class="btn-primary text-xs py-2 whitespace-nowrap">
                        <i class="fas fa-plus mr-1"></i> Agregar
                    </button>
                    </form>
                    {% else %}
                    <p class="text-xs text-white/40 text-center bg-white/5 p-2 rounded">
                        <i class="fas fa-info-circle mr-1"></i> Has alcanzado el límite de 3 canchas.
                    </p>
                    {% endif %}
                    {% else %}
                    <div
                        class="flex items-center justify-between gap-3 opacity-75 bg-white/5 p-3 rounded border border-white/5 border-dashed">
                        <button disabled class="btn-secondary text-xs opacity-50 cursor-not-allowed whitespace-nowrap">
                            <i class="fas fa-plus mr-1"></i> Agregar Cancha
                        </button>
                        <div class="text-xs text-warning flex-1 text-right leading-tight">
                            <i class="fas fa-lock mr-1"></i>
                            Solo Premium puede agregar más canchas (Max 3).
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
            </div>

            <!-- Visual Settings (Premium Only) -->
            <div class="mb-8 p-4 rounded-xl border border-white/10 relative overflow-hidden bg-white/5">
                {% if not current_user.is_active_premium %}
                <div class="absolute inset-0 bg-black/60 backdrop-blur-[1px] z-10 flex items-center justify-center">
                    <div class="text-center">
                        <i class="fas fa-crown text-yellow-500 text-2xl mb-2"></i>
                        <p class="text-white font-bold text-sm">Personalización Premium</p>
                        <p class="text-white/40 text-xs mb-3">Logos, slogans y estadísticas</p>
                        <a href="{{ url_for('premium.premium') }}"
                            class="text-xs bg-yellow-500 hover:bg-yellow-400 text-black px-3 py-1 rounded font-bold transition-colors">
                            Mejorar
                        </a>
                    </div>
                </div>
                {% endif %}

                <h3 class="text-sm font-bold text-yellow-500 mb-4 flex items-center gap-2">
                    <i class="fas fa-paint-brush"></i> Personalización Visual
                </h3>

                <div class="{% if not current_user.is_active_premium %}opacity-50 pointer-events-none{% endif %}">
                    <div class="mb-4">
                        <label class="block text-sm text-white/60 mb-2 uppercase tracking-wide">Logo de la Liga
                            (URL)</label>
                        {{ form.logo_url(class="input-field", placeholder="https://...", form="leagueSettingsForm") }}
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm text-white/60 mb-2 uppercase tracking-wide">Slogan</label>
                        {{ form.slogan(class="input-field", placeholder="Frase corta", form="leagueSettingsForm") }}
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm text-white/60 mb-2 uppercase tracking-wide">Color de
                            Credenciales</label>
                        <div class="flex items-center gap-3">
                            {{ form.credential_color(class="w-12 h-10 p-1 rounded cursor-pointer bg-transparent border
                            border-white/20", type="color", form="leagueSettingsForm") }}
                            <span class="text-xs text-white/40">Selecciona el color principal para los registros
                                (encabezado y pie de página).</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 pt-2 border-t border-white/10">
                        {{ form.show_stats(class="w-5 h-5 rounded border-white/20 bg-white/5 text-primary
                        focus:ring-primary", form="leagueSettingsForm") }}
                        <div>
                            <label class="block text-sm font-bold text-white mb-1">
                                Mostrar Estadísticas a Capitanes
                            </label>
                            <p class="text-xs text-white/50">
                                Top 5 goleadores y arqueros visibles en panel de capitanes.
                            </p>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 pt-4 border-t border-white/10">
                        {{ form.show_team_logos(class="w-5 h-5 rounded border-white/20 bg-white/5 text-primary
                        focus:ring-primary", form="leagueSettingsForm") }}
                        <div>
                            <label class="block text-sm font-bold text-white mb-1">
                                {{ form.show_team_logos.label.text }}
                            </label>
                            <p class="text-xs text-white/50">
                                Muestra los escudos de los equipos en las secciones de Resultados y Próximos Partidos
                                del reporte.
                            </p>
                        </div>
                    </div>

                    <!-- Standing Highlighting -->
                    <div class="mt-6 pt-4 border-t border-white/10">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <label class="block text-sm font-bold text-white mb-1">
                                    Resaltar Posiciones en Tabla
                                </label>
                                <p class="text-xs text-white/50">Destaca el rango de posiciones seleccionado con un
                                    color especial.</p>
                            </div>
                            <div
                                class="relative inline-block w-12 h-6 transition duration-200 ease-in-out bg-white/10 rounded-full">
                                {{ form.highlight_standings(class="opacity-0 w-0 h-0 peer", id="toggle-highlight",
                                form="leagueSettingsForm") }}
                                <label for="toggle-highlight"
                                    class="absolute top-0 left-0 right-0 bottom-0 cursor-pointer rounded-full before:absolute before:content-[''] before:h-4 before:w-4 before:left-1 before:bottom-1 before:bg-white before:transition before:duration-200 before:rounded-full peer-checked:bg-primary peer-checked:before:translate-x-6"></label>
                            </div>
                        </div>

                        <div id="highlight-settings-box"
                            class="space-y-4 {% if not league.highlight_standings %}hidden{% endif %} pl-4 border-l-2 border-primary/20">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-white/40 mb-1 uppercase">Inicio Rango</label>
                                    {{ form.highlight_start(class="input-field py-1 text-sm", type="number", min="1",
                                    id="h-start", form="leagueSettingsForm") }}
                                </div>
                                <div>
                                    <label class="block text-xs text-white/40 mb-1 uppercase">Fin Rango</label>
                                    {{ form.highlight_end(class="input-field py-1 text-sm", type="number", min="1",
                                    id="h-end", form="leagueSettingsForm") }}
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs text-white/40 mb-1 uppercase">Color de Números de
                                        Posición</label>
                                    <div class="flex items-center gap-3">
                                        {{ form.highlight_color(class="w-10 h-8 p-1 rounded cursor-pointer
                                        bg-transparent
                                        border border-white/20", type="color", form="leagueSettingsForm") }}
                                        <span class="text-xs text-white/40">Este color se aplicará a los números de las
                                            posiciones seleccionadas de la tabla.</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Match Date Personalization (Independent) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-white/5 mt-4">
                            <div>
                                <label class="block text-xs text-white/40 mb-1 uppercase">Color de Fecha
                                    (Reporte)</label>
                                <div class="flex items-center gap-2">
                                    {{ form.report_date_color(class="w-10 h-8 p-1 rounded cursor-pointer
                                    bg-transparent
                                    border border-white/20", type="color", form="leagueSettingsForm") }}
                                    <span class="text-[10px] text-white/30">Color de la fecha del
                                        partido.</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-white/40 mb-1 uppercase">Tamaño de
                                    Fecha</label>
                                <div class="flex items-center gap-2">
                                    {{ form.report_date_size(class="w-20 bg-black/20 border border-white/10
                                    rounded px-2 py-1 text-xs text-white", type="number", min="12", max="20",
                                    form="leagueSettingsForm") }}
                                    <span class="text-[10px] text-white/30">Rango: 12-20px</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" form="leagueSettingsForm"
                class="w-full btn-primary py-3 font-bold text-lg shadow-lg shadow-primary/20">
                <i class="fas fa-save mr-2"></i>Guardar Cambios
            </button>
            <!-- End Settings Tab Content -->
            <!-- End Settings Forms -->

            <!-- Danger Zone -->
            <div class="card mt-6 border-red-500/30">
                <h3 class="text-xl text-red-400 mb-4">Zona de Peligro</h3>

                <!-- Reset Season (Premium) -->
                <div class="mb-6 pb-6 border-b border-white/10">
                    <h4 class="font-bold mb-2">Restablecer Temporada</h4>
                    <p class="text-white/60 mb-4 text-sm">Reinicia todos los partidos y puntos. Mantiene equipos y
                        jugadores.</p>

                    {% if current_user.is_active_premium %}
                    <form method="POST" action="{{ url_for('match.reset_season', league_id=league.id) }}"
                        onsubmit="return confirm('¡ADVERTENCIA!\n\nEsta acción borrará TODOS los partidos, resultados y puntos de la temporada actual.\n\nNO se borrarán los equipos ni jugadores.\n\n¿Estás absolutamente seguro de continuar?')">
                        <button type="submit"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-history mr-2"></i>Restablecer Temporada
                        </button>
                    </form>
                    {% else %}
                    <button disabled class="bg-red-600/50 text-white/50 font-bold py-2 px-4 rounded cursor-not-allowed">
                        <i class="fas fa-lock mr-2"></i>Restablecer Temporada (Premium)
                    </button>
                    <p class="text-xs text-warning mt-2">
                        <a href="{{ url_for('premium.premium') }}" class="hover:underline">Actualiza a Premium para
                            desbloquear</a>
                    </p>
                    {% endif %}
                </div>

                <!-- Delete League -->
                <div>
                    <h4 class="font-bold mb-2">Eliminar Liga</h4>
                    <p class="text-white/60 mb-4 text-sm">Elimina permanentemente la liga y todos sus datos.</p>
                    <form method="POST" action="{{ url_for('league.delete_league', league_id=league.id) }}"
                        onsubmit="return confirm('¿Estás seguro? Esta acción eliminará la liga y todos sus datos.')">
                        <button type="submit"
                            class="bg-transparent border border-red-600 text-red-600 hover:bg-red-600 hover:text-white font-bold py-2 px-4 rounded transition-colors">
                            <i class="fas fa-trash mr-2"></i>Eliminar Liga
                        </button>
                    </form>
                </div>
            </div>
        </div> <!-- End Settings Tab -->
</div>
</main>
</div>

<!-- Players Data for JS -->
<script>
    window.playersByTeam = {{ players_by_team | tojson | safe }};
</script>

<!-- Share Modal -->
<div id="shareModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
    <div class="bg-[#1a2234] border border-white/10 rounded-xl w-full max-w-lg shadow-2xl relative">
        <button onclick="closeShareModal()" class="absolute top-4 right-4 text-white/40 hover:text-white">
            <i class="fas fa-times"></i>
        </button>

        <form action="{{ url_for('league.generate_share_report', league_id=league.id) }}" method="GET" target="_blank"
            class="p-6">
            <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i class="fas fa-file-export text-blue-400"></i> Generar Reporte
            </h3>

            <div class="space-y-4">
                <!-- Standings -->
                <label class="flex items-center gap-3 p-3 bg-white/5 rounded hover:bg-white/10 cursor-pointer">
                    <input type="checkbox" name="include_standings" value="on" checked
                        class="form-checkbox bg-transparent border-white/20 text-blue-500 rounded">
                    <span class="flex-1">Tabla de Posiciones</span>
                </label>

                <!-- Recent -->
                <div class="border border-white/10 rounded p-3">
                    <label class="flex items-center gap-3 mb-3 cursor-pointer">
                        <input type="checkbox" name="include_recent" value="on" id="check_recent"
                            onchange="toggleDateInputs()"
                            class="form-checkbox bg-transparent border-white/20 text-blue-500 rounded">
                        <span class="flex-1">Resultados Recientes</span>
                    </label>
                    <div id="date_inputs" class="grid grid-cols-2 gap-2 text-sm hidden pl-7">
                        <div>
                            <label class="block text-white/40 text-xs mb-1">Desde</label>
                            <input type="date" name="date_start"
                                class="w-full bg-black/20 border border-white/10 rounded px-2 py-1 text-white text-xs">
                        </div>
                        <div>
                            <label class="block text-white/40 text-xs mb-1">Hasta</label>
                            <input type="date" name="date_end"
                                class="w-full bg-black/20 border border-white/10 rounded px-2 py-1 text-white text-xs">
                        </div>
                    </div>
                </div>

                <!-- Upcoming -->
                <label
                    class="flex items-center gap-3 p-3 bg-white/5 rounded hover:bg-white/10 cursor-pointer {% if not upcoming_matches %}opacity-50 pointer-events-none{% endif %}">
                    <input type="checkbox" name="include_upcoming" value="on" {% if upcoming_matches %}checked{% else
                        %}disabled{% endif %}
                        class="form-checkbox bg-transparent border-white/20 text-blue-500 rounded">
                    <span class="flex-1">Próximos Partidos</span>
                    {% if not upcoming_matches %}<span class="text-xs text-red-400">Sin datos</span>{% endif %}
                </label>

                <!-- Stats -->
                <div class="grid grid-cols-2 gap-4">
                    <label class="flex items-center gap-3 p-3 bg-white/5 rounded hover:bg-white/10 cursor-pointer 
                        {% if not current_user.is_active_premium %}opacity-50{% endif %} 
                        {% if not top_scorers %}pointer-events-none opacity-30{% endif %}">
                        <input type="checkbox" name="include_scorers" value="on" {% if current_user.is_active_premium
                            %}checked{% else %}disabled{% endif %}
                            class="form-checkbox bg-transparent border-white/20 text-blue-500 rounded">
                        <div class="flex flex-col">
                            <span class="flex-1">Goleadores</span>
                            {% if not current_user.is_active_premium %}
                            <span class="text-xs text-yellow-500 font-bold"><i
                                    class="fas fa-crown text-[10px] mr-1"></i>Premium</span>
                            {% endif %}
                        </div>
                    </label>
                    <label class="flex items-center gap-3 p-3 bg-white/5 rounded hover:bg-white/10 cursor-pointer 
                        {% if not current_user.is_active_premium %}opacity-50{% endif %} 
                        {% if not top_goalkeepers %}pointer-events-none opacity-30{% endif %}">
                        <input type="checkbox" name="include_keepers" value="on" {% if current_user.is_active_premium
                            %}checked{% else %}disabled{% endif %}
                            class="form-checkbox bg-transparent border-white/20 text-blue-500 rounded">
                        <div class="flex flex-col">
                            <span class="flex-1">Arqueros</span>
                            {% if not current_user.is_active_premium %}
                            <span class="text-xs text-yellow-500 font-bold"><i
                                    class="fas fa-crown text-[10px] mr-1"></i>Premium</span>
                            {% endif %}
                        </div>
                    </label>
                </div>

                <!-- Extra Note (Premium) -->
                <div class="border border-white/10 rounded p-3">
                    <label class="block text-sm font-bold mb-2 flex justify-between">
                        <span>Nota Adicional</span>
                        {% if not current_user.is_active_premium %}
                        <a href="{{ url_for('premium.premium') }}"
                            class="text-xs text-yellow-400 hover:text-yellow-300">
                            <i class="fas fa-crown mr-1"></i>Premium
                        </a>
                        {% endif %}
                    </label>
                    <textarea name="report_note" rows="2"
                        placeholder="Ej: 'Equipo Monarcas descansa' o 'Llevar medias largas'"
                        class="w-full bg-black/20 border border-white/10 rounded p-2 text-white text-sm focus:outline-none focus:border-blue-500 transition-colors"
                        {% if not current_user.is_active_premium %}disabled{% endif %}></textarea>
                    {% if not current_user.is_active_premium %}
                    <p class="text-xs text-white/40 mt-1">Función exclusiva para usuarios Premium.</p>
                    {% endif %}
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button type="button" onclick="closeShareModal()"
                    class="px-4 py-2 text-white/60 hover:text-white transition-colors">Cancelar</button>
                <button type="submit"
                    class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-bold transition-colors">
                    Generar Vista Previa
                </button>
            </div>
        </form>
    </div>
</div>


<!-- Matrix Match Modal -->
<div id="matrixMatchModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
    <div class="bg-[#1a2234] border border-white/10 rounded-xl w-full max-w-lg shadow-2xl relative">
        <button onclick="closeMatrixModal()" class="absolute top-4 right-4 text-white/40 hover:text-white">
            <i class="fas fa-times"></i>
        </button>

        <form action="{{ url_for('match_matrix.save_match_matrix') }}" method="POST" class="p-6">
            <input type="hidden" name="match_id" id="matrix_match_id">
            <input type="hidden" name="league_id" value="{{ league.id }}">
            <input type="hidden" name="home_team_id" id="matrix_home_team_id">
            <input type="hidden" name="away_team_id" id="matrix_away_team_id">
            <input type="hidden" name="match_round" id="matrix_match_round">

            <h3 class="text-xl font-bold mb-6 flex items-center justify-center gap-4">
                <div class="flex flex-col items-center gap-2 w-1/3">
                    <img id="matrix_home_shield" src="" class="w-12 h-12 rounded object-cover bg-white/5">
                    <span id="matrix_home_name" class="text-xs text-center leading-tight">Home</span>
                </div>
                <div class="text-2xl font-bold text-white/40">VS</div>
                <div class="flex flex-col items-center gap-2 w-1/3">
                    <img id="matrix_away_shield" src="" class="w-12 h-12 rounded object-cover bg-white/5">
                    <span id="matrix_away_name" class="text-xs text-center leading-tight">Away</span>
                </div>
            </h3>

            <!-- Schedule -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-white/40 text-xs mb-1 uppercase">Fecha</label>
                    <input type="date" name="match_date" id="matrix_match_date" class="input-field">
                </div>
                <div>
                    <label class="block text-white/40 text-xs mb-1 uppercase">Hora</label>
                    <input type="time" name="match_time" id="matrix_match_time" class="input-field">
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-white/40 text-xs mb-1 uppercase">Cancha</label>
                <select name="court_id" id="matrix_court_id" class="input-field">
                    <option value="">-- Sin Cancha --</option>
                    {% for court in courts %}
                    <option value="{{ court.id }}">{{ court.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Scores -->
            <div class="grid grid-cols-2 gap-8 mb-6 bg-white/5 p-4 rounded-lg border border-white/5">
                <div class="text-center">
                    <label class="block text-white/40 text-xs mb-2 uppercase">Goles Local</label>
                    <input type="number" name="home_score" id="matrix_home_score"
                        class="input-field text-center text-2xl font-bold" min="0">
                </div>
                <div class="text-center">
                    <label class="block text-white/40 text-xs mb-2 uppercase">Goles Visitante</label>
                    <input type="number" name="away_score" id="matrix_away_score"
                        class="input-field text-center text-2xl font-bold" min="0">
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button type="button" id="btn-delete-matrix-match"
                    class="mr-auto text-red-400 hover:text-red-300 text-sm px-3 py-2 hidden">
                    <i class="fas fa-trash mr-1"></i> Eliminar
                </button>
                <button type="button" onclick="closeMatrixModal()"
                    class="px-4 py-2 text-white/60 hover:text-white transition-colors">Cancelar</button>
                <button type="submit" class="btn-primary px-6 py-2">
                    <i class="fas fa-save mr-2"></i>Guardar
                </button>
            </div>
        </form>

        <!-- Hidden Delete Form -->
        <form id="deleteMatrixForm" action="{{ url_for('match_matrix.delete_match_matrix') }}" method="POST"
            onsubmit="return confirm('¿Eliminar este partido?');">
            <input type="hidden" name="match_id" id="delete_matrix_match_id">
            <input type="hidden" name="league_id" value="{{ league.id }}">
        </form>
    </div>
</div>

<script>
    window.teamsData = {{ teams_js | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='js/league_detail.js') }}" defer></script>
{% endblock %}